<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" 
                    "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <link rel="stylesheet" href="qunit/qunit.css" type="text/css" media="screen" />
  <link rel="stylesheet" href="../style/test.css" type="text/css" media="screen" />

<script type="text/javascript" src="fail.js"></script>

<script type="text/javascript" src="qunit/qunit.js"></script>

<script type="text/javascript" src="../script/cgd/debug.js"></script>
<script type="text/javascript" src="../script/cgd/Module.js"></script>

  <script>

CGD.test = CGD.test || {};
CGD.test.timeout = isLocal ? 100 : 500;

module("html");

test("makes elements", function() {
  ok(CGD.html.makeTag('foo', {bar: 'bar'}));
});

test("adds an element to head", function() {
  CGD.html.addElementToHead(CGD.html.makeTag('foo', {bar: 'bar'}));
  equals(document.getElementsByTagName('foo').length, 1);
});


module("Dependency");

test("Can construct a dependency", function() {
  ok(new CGD.Dependency('pass.js'));
});

test("has path property", function()
{
  ok(new CGD.Dependency('pass.js').path);
});

test("has canonicalPath property", function()
{
  ok(new CGD.Dependency('pass.js').canonicalPath);
});

test("Can construct a dependency with a full path", function() {
  equals(new CGD.Dependency('pass.js', 'full/pass.js').canonicalPath, 'full/pass.js');
});

test("registers itself", function() {
  var files = {};
  var x = new CGD.Dependency('x.js').register(files);
  equals(files[x.path], x, 'path is registered');
  equals(files[x.canonicalPath], x, 'canonicalPath is registered');
});

test("can track whether it's loaded", function() {
  var x = new CGD.Dependency('x.js');
  equals(x.status(), 'new');
  x.loaded();
  equals(x.status(), 'loaded');
});

test("can track whether it's aborted", function() {
  var x = new CGD.Dependency('x.js');
  equals(x.status(), 'new');
  x.aborted();
  equals(x.status(), 'aborted');
});

test("infer file type", function() {
  equals(new CGD.Dependency('type.js').type, 'text/javascript');
  equals(new CGD.Dependency('type.css').type, 'text/css');
});

test("makes matching element", function() {
  ok(new CGD.Dependency('el.js').element());
});

test("includes a file", function() {
  expect(1);
  stop();
  new CGD.Dependency('pass.js').include();
  setTimeout(start, CGD.test.timeout);
});

test("improves canonicalPath", function() {
  file = new CGD.Dependency('subdir/../el.js');
  file.element();
  ok(file.canonicalPath.match('qunit/el.js'), file.canonicalPath);
});

test("require avoids aliasing", function() {
  expect(1);
  stop();
  CGD.mod.require('alias.js');
  CGD.mod.require('subdir/../alias.js');
  setTimeout(start, CGD.test.timeout);
});

module("Module");

test("construct a module", function() {
  expect(1);
  new CGD.Module('subdir/subpass.js', function(m) {
    ok(m);
  });
});

test("includes a file", function() {
  expect(1);
  stop();
  CGD.mod.include('pass.js');
  setTimeout(start, CGD.test.timeout);
});

test("includes a file twice", function() {
  expect(2);
  stop();
  CGD.mod.include('pass.js');
  CGD.mod.include('pass.js');
  setTimeout(start, CGD.test.timeout);
});

test("detects static script files", function() {
  for (var i in CGD.mod.files) {
    if (CGD.mod.files[i].canonicalPath.match(/qunit.js/)) {
      ok(true, 'found static file');
      return;
    }
  }
  ok(false, 'did not find static file');
});

test("require includes a file only once", function() {
  expect(0);
  stop();
  CGD.mod.require('fail.js');
  setTimeout(start, CGD.test.timeout);
});

test("relative path context", function() {
  new CGD.Module("dummy.js", function(mod){
    ok(!mod.path.match('subdir'), 'subdir not previously in path');
    mod.under('subdir', function(m) {
      ok(m.path.match('subdir'), 'subdir now in path');
    });
    ok(!mod.path.match('subdir'), 'subdir not in path');
  });
});

test("relative path context doesn't double queued count", function() {
  try {
    new CGD.Module("noop.js", function(mod) {
      equals(mod.queued, 0);
      mod.require('dummychild.js');
      equals(mod.queued, 1);
      mod.under('subdir/', function(m) {
        equals(m.queued, 0);
        m.require('dummysubchild.js');
        equals(m.queued, 1);
      });
      equals(mod.queued, 2);
    });
  } catch(e) {
    if (!(e instanceof CGD.Module.DependenciesNotYetLoaded)) {
      throw e;
    }
  }
});

test("absolute path context", function() {
  ok(!CGD.mod.path.match('subdir'), 'subdir not previously in path');
  new CGD.Module('subdir/subpass.js', function(m) {
    ok(m.path.match('subdir'), 'subdir now in path');
  });
  ok(!CGD.mod.path.match('subdir'), 'subdir not in path');
});

test("doesn't get substrings", function() {
  new CGD.Module('ias.js', function(m) {
    ok(!m.root.match('al$'), m.root);
  });
});

test("exceptions don't corrupt context", function() {
  expect(1);
  stop();
  try {
    new CGD.Module('subdir/subpass.js', function() {
      throw "blarg";
    });
  }
  catch (s) {}
  CGD.mod.require("uncorrupted.js");
  setTimeout(start, CGD.test.timeout);
});

test("module can load dependencies before continuing", function() {
  expect(1);
  stop();
  CGD.mod.require('subdir/submod.js');
  setTimeout(start, CGD.test.timeout);
});

test("handles base directory module", function() {
  expect(1);
  stop();
  CGD.mod.require('module.js');
  setTimeout(start, CGD.test.timeout);
});

test("loaded files are known", function() {
  CGD.mod.require('loadme.js');
  
  ok(CGD.mod.fileFromPath('loadme.js').file);
  ok(CGD.mod.fileFromPath('loadme.js').element);
});

test("file state changes from unloaded to loaded", function() {
  CGD.mod.require('loadme.js');
  
  equals(CGD.mod.files['loadme.js'].status(), 'pending');
  stop();
  setTimeout(function() {
    equals(CGD.mod.files['loadme.js'].status(), 'loaded');
    start();
  }, CGD.test.timeout);
});

test("canceled load doesn't appear loaded", function() {
  CGD.mod.require('reloadparent/parent.js');
  
  expect(2);
  stop();
  setTimeout(function() {
    equals(CGD.mod.files['reloadparent/parent.js'].status(), 'loaded');
    start();
  }, CGD.test.timeout);
});

test("out-of-order mutual dependencies", function() {
  expect(3);
  stop();
  CGD.mod.require('conflict/top.js');
  setTimeout(start, CGD.test.timeout);
});

test("distant modules", function() {
  expect(3);
  stop();
  CGD.mod.require('../distant/distantmodule.js');
  setTimeout(start, CGD.test.timeout);
});

test("prevents infinite reload", function() {
  expect(0);
  CGD.mod.require('infinite.js');
  stop();
  setTimeout(start, 1000);
});

  </script>
  
</head>
<body onload="CGD.DEBUG.onload();">
 <h1 id="qunit-header">QUnit example</h1>
 <h2 id="qunit-banner"></h2>
 <h2 id="qunit-userAgent"></h2>
 <ol id="qunit-tests"></ol>
 <div id="debugDiv" />
</body>
</html>
</html>